<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/png" href="img/favicon.png"/>
    <title>European population map</title>
    <style>
        html { height: 100%; margin:0; padding:0; }
        body { height: 100%; margin:0; padding:0; font-family: "Myriad Pro", Myriad, MyriadPro-Regular, 'Myriad Pro Regular', MyriadPro, 'Myriad Pro', "Liberation Sans", "Nimbus Sans L", "Helvetica Neue", vegur, Vegur, Helvetica, Arial, sans-serif; }
        #bck { fill: LightSteelBlue; }
        .bn { fill: none; stroke-linecap: round; stroke-linejoin: round }
        .bn_0 { stroke: #777; stroke-width: 1px; }
        .bn_1 { stroke: none; }
        .bn_2 { stroke: none; }
        .bn_3 { stroke: none; }
        .bn_oth { stroke: #444; stroke-width: 1px; }
        .cntrg { fill: lightgray; }
        .cntrg:hover { fill: darkgray; }
        .cntbn { fill: none; stroke: #777; stroke-width: 1px; stroke-linecap:round; stroke-linejoin:round }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>

    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <script src="js/json-stat.js"></script>

    <script src="js/lib.js"></script>
    <script src="js/eurostat-lib.js"></script>

</head>

<body>
<svg id="map"></svg>
<div id="tooltip"></div>

<script>
    //See also: http://d3-legend.susielu.com/
    //See also: https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.9.0/d3-legend.min.js

    //get url parameters for size, nuts level, time and projection
    var size = ( EstLib.getParameterByName("s") || 1200 ) + "px",
	nutsLvl = EstLib.getParameterByName("lvl") || "3",
	time = EstLib.getParameterByName("time") || "2014",
	proj = EstLib.getParameterByName("proj") || "laea",
        lg="en",
	year=2013,

    //build blank svg
            width = "100%",
            height = "100%",
    //build svg
            svg = d3.select("#map").attr("width", width).attr("height", height);
    //background rectangle
    svg.append("rect").attr("id","bck").attr("x",0).attr("y",0).attr("width", width).attr("height", height);
    //drawing group
    var g = svg.append("g").attr("transform","translate(0,0)");

    //zooming capability
    var zoom;
    svg.call(zoom=d3.zoom().scaleExtent([0.5,6]).on("zoom", function() {
        var k = d3.event.transform.k;
        d3.selectAll(".bn_0").style("stroke-width", (1/k)+"px");
        d3.selectAll(".bn_oth").style("stroke-width", (1/k)+"px");
        d3.selectAll(".cntbn").style("stroke-width", (1/k)+"px");
        g.attr("transform", d3.event.transform);
    }));

    //tooltip element
    var tooltip = EstLib.tooltip();

    //show loading image
    var loadingDiv = EstLib.loadingImage({imgsrc:"img/loading.png"});

    var path = d3.geoPath().projection(null);

    //build color scale
    var colors = [];
    for(var t=0; t<=1; t+=1/7) colors.push(d3.interpolateYlOrRd(t));

    //launch HTTP queries
    $.when(
            //get nuts geometries
            $.ajax({url:"https://rawgit.com/eurostat/Nuts2json/gh-pages/topojson/"+year+"/"+proj+"/"+size+"/"+nutsLvl+".json"}),
            //get population data
            $.ajax({url:EstLib.getEstatDataURL("demo_r_d3dens",{time:time})}, lg)
    ).then(function(nuts,data) {
                data=data[0]; nuts=nuts[0];

                //decode stat data
                data = JSONstat(data).Dataset(0);

                //hide loading image
                loadingDiv.hide();

                zoom.scaleBy(svg, 0.5);
                //zoom.translateBy(svg,(-nuts.bbox[0]),(-nuts.bbox[1]));
                zoom.translateBy(svg,0,-300);

                //draw countries
                g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.cntrg).features).enter()
                        .append("path").attr("d", path)
                        .attr("class", "cntrg")
                        .on("mouseover", function(rg) { tooltip.mouseover(rg.properties.cna); })
                        .on("mousemove", function() { tooltip.mousemove(); })
                        .on("mouseout", function() { tooltip.mouseout(); })
                g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.cntbn).features).enter()
                        .append("path").attr("d", path)
                        .attr("class", "cntbn");

                //decode NUTS regions data
                var nutsRG = topojson.feature(nuts, nuts.objects.nutsrg).features;

                //link values to NUTS regions and build values list for color legend
                var values=[];
                for(var i=0; i<nutsRG.length; i++){
                    var rg = nutsRG[i];
                    var value = data.Data({geo: rg.properties.id});
                    if(!value || !value.value) continue;
                    rg.properties.val = value.value;
                    values.push(+value.value);
                }

                //build color scale based on quantiles
                var scale = d3.scaleQuantile().domain(values).range(colors);
                scale.quantiles();

                //draw regions
                g.append("g").selectAll("path").data(nutsRG).enter()
                        .append("path").attr("d", path)
                        .attr("fill", function(rg){
                            if(!rg.properties.val) return "lightgray";
                            return scale(+rg.properties.val);
                        })
                        .on("mouseover", function(rg) {
                            var rg_ = d3.select(this);
                            rg_.attr("fill___", rg_.style("fill"));
                            rg_.style("fill","purple");
                            tooltip.mouseover("<b>"+rg.properties.na+"</b><br>"+rg.properties.val+" people/kmÂ²");
                        })
                        .on("mousemove", function() { tooltip.mousemove(); })
                        .on("mouseout", function() {
                            var rg_ = d3.select(this);
                            rg_.style("fill",rg_.attr("fill___"));
                            tooltip.mouseout();
                        });

                //draw borders
                //TODO do not draw the ones with stroke:none
                var bn = topojson.feature(nuts, nuts.objects.nutsbn).features;
                bn.sort(function(bn1,bn2){ return bn2.properties.lvl - bn1.properties.lvl; });
                g.append("g").selectAll("path").data(bn).enter()
                        .append("path").attr("d", path)
                        .attr("class", function(bn){
                            bn = bn.properties;
                            //eu=EU_FLAG,efta=EFTA_FLAG,cc=CC_FLAG,lvl=STAT_LEVL_,oth=OTHR_CNTR_
                            var cl = ["bn","bn_"+bn.lvl];
                            if(bn.oth==="T") cl.push("bn_oth");
                            return cl.join(" ");
                        });
            }
    );

</script>
</body>
