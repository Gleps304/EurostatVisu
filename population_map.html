<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/png" href="img/favicon.png"/>
    <title>European population map</title>
    <style>
        html { height: 100%; margin:0; padding:0; }
        body { height: 100%; margin:0; padding:0; font-family: "Myriad Pro", Myriad, MyriadPro-Regular, 'Myriad Pro Regular', MyriadPro, 'Myriad Pro', "Liberation Sans", "Nimbus Sans L", "Helvetica Neue", vegur, Vegur, Helvetica, Arial, sans-serif; }
        #bck { fill: #b3cde3; }
        .bn { fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .bn_0 { stroke: #777; stroke-width: 1px; }
        .bn_1 { stroke: none; }
        .bn_2 { stroke: none; }
        .bn_3 { stroke: none; }
        .bn_oth { stroke: #444; stroke-width: 1px; }
        .cntrg { fill: lightgray; }
        .cntrg:hover { fill: darkgray; }
        .cntbn { fill: none; stroke: #777; stroke-width: 1px; stroke-linecap:round; stroke-linejoin:round; }
        .gra { fill: none; stroke: gray; stroke-width: 1px; }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>

    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <script src="js/json-stat.js"></script>

    <script src="js/lib.js"></script>
    <script src="js/eurostat-lib.js"></script>

</head>

<body>
<svg id="map"></svg>
<div id="tooltip"></div>

<script>
    //show loading image
    var loadingDiv = EstLib.loadingImage({imgsrc:"img/loading.png"});

    //get url parameters for width, nuts level, time and projection
    var width = EstLib.getParameterByName("s") || 800,
		nutsLvl = EstLib.getParameterByName("lvl") || "3",
		time = EstLib.getParameterByName("time") || "2016",
		proj = EstLib.getParameterByName("proj") || "3035",
        lg="en",
        NUTSyear = EstLib.getParameterByName("y") || 2013
	;

    //tooltip element
    var tooltip = EstLib.tooltip();

    //build color scale
    var colors = [];
    for(var t=0; t<=1; t+=1/7) colors.push(d3.interpolateYlOrRd(t));

    //launch HTTP queries
    $.when(
            //get nuts geometries
            $.ajax({url:"https://raw.githubusercontent.com/eurostat/Nuts2json/gh-pages/"+NUTSyear+"/"+proj+"/"+width+"px"+"/"+nutsLvl+".json"}),
            //get population data
            $.ajax({url:EstLib.getEstatDataURL("demo_r_d3dens",{time:time})}, lg)
    ).then(function(nuts,data) {
                //hide loading image
                loadingDiv.hide();

                //decode nuts geometry data
                nuts = JSON.parse(nuts[0]);
                //decode stat data
                data = JSONstat(data[0]).Dataset(0);

                //build blank svg
        		var height = width*(nuts.bbox[3]-nuts.bbox[1])/(nuts.bbox[2]-nuts.bbox[0]),
        			svg = d3.select("#map").attr("width", width).attr("height", height)
					path = d3.geoPath().projection(d3.geoIdentity().reflectY(true).fitSize([width,height], topojson.feature(nuts, nuts.objects.gra)))
				;

                //draw background rectangle
                svg.append("rect").attr("id","bck").attr("x",0).attr("y",0).attr("width", width).attr("height", height);
                //prepare drawing group
                var g = svg.append("g").attr("transform","translate(0,0)");

                //add zooming function
                var zoom;
                svg.call(zoom=d3.zoom().scaleExtent([0.5,6]).on("zoom", function() {
                    var k = d3.event.transform.k;
                    d3.selectAll(".bn_0").style("stroke-width", (1/k)+"px");
                    d3.selectAll(".bn_oth").style("stroke-width", (1/k)+"px");
                    d3.selectAll(".cntbn").style("stroke-width", (1/k)+"px");
                    g.attr("transform", d3.event.transform);
                }));

        		//draw graticule
        		g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.gra).features).enter()
        			.append("path").attr("d", path)
					.attr("class", "gra");

                //draw countries
				g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.cntrg).features).enter()
					.append("path").attr("d", path)
					.attr("class", "cntrg")
					.on("mouseover", function(rg) { tooltip.mouseover(rg.properties.na); })
					.on("mousemove", function() { tooltip.mousemove(); })
					.on("mouseout", function() { tooltip.mouseout(); })
				g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.cntbn).features).enter()
					.append("path").attr("d", path)
					.attr("class", "cntbn");

                //prepare NUTS regions data
				var nutsRG = topojson.feature(nuts, nuts.objects.nutsrg).features;

				//link values to NUTS regions and build values list for color legend
				var values=[];
				for(var i=0; i<nutsRG.length; i++){
                    var rg = nutsRG[i];
                    var value = data.Data({geo: rg.properties.id});
                    if(!value || !value.value) continue;
                    rg.properties.val = value.value;
                    values.push(+value.value);
                }

                //build color scale based on quantiles
                var scale = d3.scaleQuantile().domain(values).range(colors);
                scale.quantiles();

                //draw NUTS regions regions
                g.append("g").selectAll("path").data(nutsRG).enter()
                        .append("path").attr("d", path)
                        .attr("fill", function(rg){
                            if(!rg.properties.val) return "lightgray";
                            return scale(+rg.properties.val);
                        })
                        .on("mouseover", function(rg) {
                            var rg_ = d3.select(this);
                            rg_.attr("fill___", rg_.style("fill"));
                            rg_.style("fill","purple");
                            tooltip.mouseover("<b>"+rg.properties.na+"</b><br>"+rg.properties.val+" people/kmÂ²");
                        })
                        .on("mousemove", function() { tooltip.mousemove(); })
                        .on("mouseout", function() {
                            var rg_ = d3.select(this);
                            rg_.style("fill",rg_.attr("fill___"));
                            tooltip.mouseout();
                        });

                //draw boundaries
                var bn = topojson.feature(nuts, nuts.objects.nutsbn).features;
                bn.sort(function(bn1,bn2){ return bn2.properties.lvl - bn1.properties.lvl; });
                g.append("g").selectAll("path").data(bn).enter()
                        .append("path").attr("d", path)
                        .attr("class", function(bn){
                            bn = bn.properties;
                            var cl = ["bn","bn_"+bn.lvl];
                            if(bn.oth==="T") cl.push("bn_oth");
                            return cl.join(" ");
                        });
            }
    );
</script>
</body>
