<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf8" />
    <title>Income disparities in Europe</title>

    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">

    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/colorbrewer.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/json-stat.js"></script>
    <script src="js/lib.js"></script>
    <script src="js/eurostat-lib.js"></script>

    <style>
        body {
            font-family: sans-serif;
        }

        h1 {
            font-size: 22px;
        }

        #disrect rect {
            /*fill: peru;*/
            stroke-width: 0.5;
            stroke: lightgray;
        }

        #timeslider label {
            position: absolute;
            width: 20px;
            margin-top: 12px;
            margin-left: -10px;
            text-align: center;
            font-size: 10px;
        }

        .chartLabels{
            font-size: 14px;
            /*fill: gray;*/
        }
        .arrow{
            marker-end: url(#arrow);
            stroke: gray;
            stroke-width: 2.5px;
        }
        #averageLine{
            stroke: black;
            stroke-width: 2px;
            opacity: 0.5;
        }
        .graticuleYline{
            stroke: black;
            stroke-width: 2px;
            opacity: 0.15;
        }

        .ui-widget {
            font-size: 12px !important;
        }

        p {
            font-size: 10px;
        }

    </style>

</head>

<body>
<h1><span id="title1"></span> - <span id="geoTitle">-</span> <span id="title2"></span> <span id="timeTitle">-</span></h1>
<div style="float: left; width:250px; margin-left: 10px; margin-right: 10px;">
    <span id="countryText"></span>
    <div id="geoListDiv">
        <select name="geoN" id="geoList"></select>
    </div>
    <div style="margin-top: 5px;">
        <span id="yearText"></span>
        <div id="timeslider"></div>
    </div>
    <div id="info" style="width:240px; margin-top: 25px;"></div>
</div>
<div id="chart"></div>
<div>
    <p>
        <span id="sourceTxt"></span>
    </p>
</div>

<script>

    /**
     *
     * @author julien Gaffuri
     *
     */
    (function($) {
        $(function() {
            //TODO restructure like: http://bl.ocks.org/mbostock/4e3925cdc804db257a86fdef3a032a45 Check webstr behaviour.

            //TODO german translation
            //TODO show quintiles, quartiles, etc.
            //TODO extract rect function and make 'small multiples' visualisation
            //TODO slider refresh

            //get language
            var lg = PrVis.getParameterByName("lang") || PrVis.getLang() || "en";
            lg = lg.substring(0, 2);

            //build translation dictionnary
            var dict = {
                en:{
                    title:"Income disparities in Europe",
                    title1:"Income disparities",
                    title2:"in",
                    countryText:"Country",
                    yearText:"Year",
                    avincome:"Average income",
                    lowincome:"Lowest incomes",
                    higincome:"Highest incomes",
                    incomelev:"Income level",
                    incomeof:"The income of the",
                    ofpopwith:"of the population with the",
                    lowest:"lowest",
                    highest:"highest",
                    incomeis:"income is",
                    oftotal:"of the total country income",
                    ifincomewas:"If the country income was equally distributed, it would be",
                    thisincis:"This income is",
                    times:"times",
                    higher:"higher",
                    lower:"lower",
                    thanav:"than the average income",
                    percent:"percent",
                    twentieth:"twentieth",
                    twentyfifth:"twentyfifth",
                    tenth:"tenth",
                    sourceTxt:"Sources: <a href='http://ec.europa.eu/eurostat/'>Eurostat</a> databases on income distribution (<a href='http://ec.europa.eu/eurostat/web/income-and-living-conditions/overview'>EU-SILC</a>). More information <a href='http://ec.europa.eu/eurostat/statistics-explained/index.php/Income_distribution_statistics'>here</a>."
                },
                fr:{
                    title:"Disparités de revenus en Europe",
                    title1:"Disparités de revenus",
                    title2:"en",
                    countryText:"Pays",
                    yearText:"Année",
                    avincome:"Revenu moyen",
                    lowincome:"Bas revenus",
                    higincome:"Hauts revenus",
                    incomelev:"Niveau de revenu",
                    incomeof:"Les revenus du",
                    ofpopwith:"de la population avec les",
                    lowest:"plus bas",
                    highest:"plus hauts",
                    incomeis:"revenus est",
                    oftotal:"du total des revenus du pays",
                    ifincomewas:"Si les revenus étaient équitablement répartis, ce serait",
                    thisincis:"Ces revenus sont",
                    times:"fois",
                    higher:"plus hauts",
                    lower:"plus bas",
                    thanav:"que le revenu moyen",
                    percent:"pourcent",
                    twentieth:"vingtième",
                    twentyfifth:"vingtcinquième",
                    tenth:"dixième",
                    sourceTxt:"Sources: Bases de données <a href='http://ec.europa.eu/eurostat/'>Eurostat</a> sur la répartition des revenus (<a href='http://ec.europa.eu/eurostat/web/income-and-living-conditions/overview'>EU-SILC</a>). Plus d'information <a href='http://ec.europa.eu/eurostat/statistics-explained/index.php/Income_distribution_statistics'>ici</a>."
                }
            };

            //select dictionnary
            dict = dict[lg] || dict.en;
            //try to fill page with translated terms
            PrVis.writeText(dict);


            //write page title
            document.title = dict.title;

            //build svg element
            var margin = {top: 0, right: 0, bottom: 40, left: 30};
            var width = 600 - margin.left - margin.right, height = 350 - margin.top - margin.bottom;
            var svg = d3.select("#chart").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);
            var chart = svg.append("g").attr("transform", "translate("+margin.left+","+margin.top+ ")");

            //chart axis scales
            var xScale = d3.scale.linear().domain([0,100]).range([0, width]);
            var yMax = 75; //TODO adapt max? min?
            var yScale = d3.scale.linear().domain([0,yMax]).range([0, height]);

            //define arrow marker
            svg.append("defs").append("marker")
                    .attr({"id":"arrow", "viewBox":"0 -5 10 10", "refX":5, "refY":0, "markerWidth":3, "markerHeight":3, "orient":"auto"})
                    .append("path").attr("d", "M0,-5L10,0L0,5");

            //draw axis labels
            var labelsG = svg.append("g").attr("transform", "translate("+margin.left+","+margin.top+ ")");
            labelsG.append("text").attr("class","chartLabels").attr("x",47).attr("y",height+17).text(dict.lowincome);
            labelsG.append('line').attr({class:"arrow", "x1":150, "y1":height+25, "x2":40, "y2":height+25});
            labelsG.append("text").attr("class","chartLabels").attr("x",width-150).attr("y",height+17).text(dict.higincome);
            labelsG.append('line').attr({class:"arrow", "x1":width-150, "y1":height+25, "x2":width-45, "y2":height+25});
            labelsG.append("text").attr("class","chartLabels").attr("transform", "translate(17,"+(height*0.5)+")rotate(-90)").attr("x",0).attr("y",0).text(dict.incomelev);
            labelsG.append('line').attr({class:"arrow", "x1":25, "y1":height*0.5+5, "x2":25, "y2":height*0.5-90});

            //draw y graticule
            for(var y=20; y<yMax; y+=10)
                labelsG.append('line').attr({class:"graticuleYline", x1:0, y1:height-yScale(y), x2:width, y2:height-yScale(y)});
            //draw average line
            labelsG.append('line').attr({id:"averageLine", x1:0, y1:height-yScale(10), x2:width, y2:height-yScale(10)});
            labelsG.append("text").attr({x:5,y:height-yScale(10)-3,"font-size":"11px"}).text(dict.avincome);

            //geo list and time slider
            var geoList = $("#geoList");
            var sli = $("#timeslider");
            sli.css("width",200);

            //info div
            var infoDiv = d3.select("#info");

            //the selection
            var geoSel = PrVis.getParameterByName("geo") || "EU28";
            var timeSel = PrVis.getParameterByName("time") || "2013";

            //some quantile data
            var quantileDict = {P:{percentage:1,text:"percent"},T:{percentage:5,text:"twentieth"},TF:{percentage:4,text:"twentyfifth"},D:{percentage:10,text:"tenth"}};

            $.when(
                    //get income distribution data
                    $.ajax({url:EstLib.getEstatDataURL("ilc_di01",{currency:"EUR",indic_il:"SHARE",
                                quantile:["P100","P99","P98","P97","P96","P95","D10","D9","D8","D7","D6","D5","D4","D3","D2","D1","P5","P4","P3","P2","P1"]
                            }, lg
                    )})
            ).then(function(data) {
                        var i;

                        //simplify geo label texts
                        EstLib.overrideCountryNames(data.dimension.geo.category.label);

                        //decode data
                        data = JSONstat(data).Dataset(0);

                        //build geolist
                        var geos = data.Dimension("geo").id;
                        EstLib.fillGeoList(geoList, geos, function(geo){return data.Dimension("geo").Category(geo).label;});
                        $('#geoList option[value='+geoSel+']').attr('selected', 'selected');
                        geoList.selectmenu({
                            change:function(){ geoSel=geoList.find(":selected").attr("value"); update(); }
                        })
                                .selectmenu("menuWidget").css("height","200px")/*.css("font-size","70%")*/;

                        //build time slider
                        var times = data.Dimension("time").id;
                        sli.slider({
                            min: +times[0],
                            max: +times[times.length-1],
                            step: 1,
                            value: timeSel,
                            change: function() { timeSel= ""+sli.slider("value"); update(); }
                            //slide: function() { timeSel= ""+sli.slider("value"); update(); }
                        }).each(function() {
                            var opt = $(this).data().uiSlider.options;
                            var www = opt.max - opt.min;
                            for (var i = opt.min; i <= opt.max; i+=5)
                                sli.append( $('<label>' + i + '</label>').css('left', ((i-opt.min)/www*100) + '%') );
                        });



                        //try to retrieve a quantile value
                        var getValue = function(quantile){
                            var d = data.Data({currency:"EUR",indic_il:"SHARE",time:timeSel,geo:geoSel,quantile:quantile});
                            if(!d) return 0;
                            //if(d.value<0) console.log(quantile,d.value)
                            return d.value || 0;
                        };

                        //compute second twentile as first decile value minus five first percentiles values
                        var get2TwentileValue = function(){
                            var v = getValue("D1");
                            for(i=1;i<=5;i++) v -= getValue("P"+i);
                            return Math.round(v*10)/10;
                        };
                        //compute 19th twentile value as last decile value, minus five last percentiles values
                        var getTwentyFifthValue = function(){
                            var v = getValue("D10");
                            for(i=95;i<=100;i++) v -= getValue("P"+i);
                            return Math.round(v*10)/10;
                        };

                        //check if percentile data is available
                        var percentileDataPresent = function(first){
                            var nbs = first? [1,2,3,4,5] : [95,96,97,98,99];
                            //check presence of 5 percentiles
                            for(var i=0;i<=4;i++){
                                var d = data.Data({currency:"EUR",indic_il:"SHARE",time:timeSel,geo:geoSel,quantile:"P"+nbs[i]});
                                if(!d || !d.value){
                                    //console.log("No percentile data for percentile "+nbs[i]);
                                    return false;
                                }
                            }
                            return true;
                        };

                        //check if all decile data is available
                        var decileDataPresent = function(){
                            for(var i=1;i<=10;i++){
                                var d = data.Data({currency:"EUR",indic_il:"SHARE",time:timeSel,geo:geoSel,quantile:"D"+i});
                                if(!d || !d.value){
                                    return false;
                                }
                            }
                            return true;
                        };

                        //update the chart
                        var update = function(){
                            //clear previous
                            chart.selectAll("*").remove();

                            //distribution rectangles group
                            var rects = chart.append("g").attr("id","disrect");

                            //draw distribution rectangle
                            var addRect = function(quantileType,quantileNb,factor,value,pos,size){
                                rects.append("rect").attr("x",xScale(pos)).attr("y",yScale(value<0?yMax:yMax-factor*value))
                                        .attr("width",xScale(size)).attr("height",yScale(factor*Math.abs(value)))
                                        .attr("fill","peru")
                                        .on("mouseover", function() {
                                            var html = [];
                                            var q = quantileDict[quantileType];
                                            var lowestIncome = 100/(quantileNb*q.percentage) >= 2;
                                            var coeff = value/q.percentage;
                                            if(value<0)
                                                html.push(
                                                        "The income of the <b>",
                                                        PrVis.getNumbered(lowestIncome?quantileNb:100/q.percentage-quantileNb+1),
                                                        " ",
                                                        q.text,
                                                        "</b> of the population with the ",
                                                        lowestIncome?"lowest":"highest",
                                                        " income is <span style='color: crimson'>negative</span>: <b>",
                                                        value,
                                                        "%</b> of the total country income."
                                                );
                                            else
                                                html.push(
                                                        dict.incomeof, " <b>",
                                                        PrVis.getNumbered(lowestIncome?quantileNb:100/q.percentage-quantileNb+1, lg),
                                                        " ",
                                                        dict[q.text],
                                                        "</b> ",dict.ofpopwith," ",
                                                        lowestIncome?dict.lowest:dict.highest,
                                                        " ",dict.incomeis," <b>",
                                                        value,
                                                        "%</b> ",dict.oftotal,".<br>",
                                                        dict.ifincomewas," <b>",
                                                        q.percentage,
                                                        "%</b>. ",dict.thisincis," ",
                                                        coeff>2||coeff<0.5?"<span style='color: crimson'>":"",
                                                        "<b>",
                                                        Math.round(10*(coeff>1?coeff:1/coeff))/10,
                                                        " ",dict.times," ",
                                                        coeff>1?dict.higher:dict.lower,
                                                        "</b>",
                                                        coeff>2||coeff<0.5?"</span>":"",
                                                        " ",dict.thanav,"."
                                                );
                                            infoDiv.html(html.join(""));
                                            d3.select(this).attr("fill","darkred ");
                                        })
                                        .on("mouseout", function() {
                                            infoDiv.text("");
                                            d3.select(this).attr("fill","peru");
                                        })
                                ;
                            };

                            //background rectangle
                            rects.append("rect").attr({y:0,x:0,width:width,height:height,fill:"#f5f5f5"});

                            if(!percentileDataPresent(true) && !percentileDataPresent(false) && !decileDataPresent()) {
                                //if no data, write message and hide labels
                                chart.append("text").attr({x:width*0.5-30,y:height*0.5,"font-size":"18px"}).text("No data");
                                labelsG.style("opacity", 0);
                            } else {
                                //show labels
                                labelsG.style("opacity", 1);

                                if(percentileDataPresent(true)){
                                    //first 5 percentiles
                                    for(i=0;i<=4;i++) addRect("P",i+1,10,getValue("P"+(i+1)),i,1);
                                    //second twentile
                                    addRect("T",2,2,get2TwentileValue(),5,5);
                                } else {
                                    //first decile
                                    addRect("D",1,1,getValue("D1"),0,10);
                                }

                                //8 deciles in the middle
                                for(i=2;i<=9;i++) addRect("D",i,1,getValue("D"+i),10*(i-1),10);

                                if(percentileDataPresent(false)){
                                    //19th twentyfifth
                                    addRect("TF",24,2.5,getTwentyFifthValue(),90,4);
                                    //last 5 percentiles
                                    for(i=95;i<=100;i++) addRect("P",i,10,getValue("P"+i),i-1,1);
                                } else {
                                    //last decile
                                    addRect("D",10,1,getValue("D10"),90,10);
                                }
                            }

                            //select geoSel in list
                            $('#geoList option[value='+geoSel+']').attr('selected', 'selected');
                            //bold time legend label
                            d3.selectAll(".lgdT").attr("font-weight","normal").attr("fill","black");
                            d3.selectAll(".lgdT[time='"+timeSel+"']").attr("font-weight","bold").attr("fill","maroon");
                            //update title
                            d3.select("#geoTitle").text(data.Dimension("geo").Category(geoSel).label);
                            d3.select("#timeTitle").text(timeSel);
                        };

                        update();

                    }, function() {
                        console.log("Could not load data");
                    }
            );
        });
    }(jQuery));

</script>

</body>
</html>
