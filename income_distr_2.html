<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf8" />
    <title>Income disparities in Europe</title>

    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">

    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/colorbrewer.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/json-stat.js"></script>
    <script src="js/lib.js"></script>
    <script src="js/eurostat-lib.js"></script>

    <style>
        body {
            font-family: sans-serif;
        }

        h1 {
            font-size: 22px;
        }

        .disrect rect {
            /*fill: peru;*/
            stroke-width:0;
        }

        #timeslider label {
            position: absolute;
            width: 20px;
            margin-top: 12px;
            margin-left: -10px;
            text-align: center;
            font-size: 10px;
        }

        .chartLabels {
            font-size: 14px;
            /*fill: gray;*/
        }

        .arrow {
            marker-end: url(#arrow);
            stroke: gray;
            stroke-width: 2.5px;
        }

        #averageLine {
            stroke: black;
            stroke-width: 2px;
            opacity: 0.5;
        }

        .graticuleYline {
            stroke: black;
            stroke-width: 2px;
            opacity: 0.15;
        }

        .ui-widget {
            font-size: 12px !important;
        }

        p {
            font-size: 10px;
        }
    </style>

</head>

<body>
<h1>
    <span id="title1"></span> <span
        id="title2"></span> <span id="timeTitle">-</span>
</h1>
<div style="margin-bottom: 20px; margin-left: 10px;">
    <span id="yearText"></span>
    <div id="timeslider"></div>
</div>
<div id="charts"></div>
<div>
    <p>
        <span id="sourceTxt"></span>
    </p>
</div>

<script>

    /**
     *
     * @author julien Gaffuri
     *
     */
    (function($) {
        $(function() {
            //http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=ilc_di01&lang=fr

            //TODO darker backgrounds
            //TODO change order - start with EU and EA, with other color ? See p35
            //TODO link both visualisations
            //TODO handle country name translation in EstLib.overrideCountryNames
            //TODO translate "no data"
            //TODO flags. display country names?
            //TODO mouse over event
            //TODO change icon shape on mouse over

            //get language
            var lg = PrVis.getLang2Chars();

            //build translation dictionnary
            var dict = {
                en:{
                    title:"Income disparities in Europe",
                    title1:"Income disparities",
                    title2:"in",
                    countryText:"Country",
                    yearText:"Year",
                    avincome:"Average income",
                    lowincome:"Lowest incomes",
                    higincome:"Highest incomes",
                    incomelev:"Income level",
                    incomeof:"The income of the",
                    ofpopwith:"of the population with the",
                    lowest:"lowest",
                    highest:"highest",
                    incomeis:"income is",
                    oftotal:"of the total country income",
                    ifincomewas:"If the country income was equally distributed, it would be",
                    thisincis:"This income is",
                    times:"times",
                    higher:"higher",
                    lower:"lower",
                    thanav:"than the average income",
                    percent:"percent",
                    twentieth:"twentieth",
                    twentyfifth:"twentyfifth",
                    tenth:"tenth",
                    sourceTxt:"Sources: <a href='http://ec.europa.eu/eurostat/'>Eurostat</a> databases on income distribution (<a href='http://ec.europa.eu/eurostat/web/income-and-living-conditions/overview'>EU-SILC</a>). More information <a href='http://ec.europa.eu/eurostat/statistics-explained/index.php/Income_distribution_statistics'>here</a>."
                },
                fr:{
                    title:"Disparités de revenus en Europe",
                    title1:"Disparités de revenus",
                    title2:"en",
                    countryText:"Pays",
                    yearText:"Année",
                    avincome:"Revenu moyen",
                    lowincome:"Bas revenus",
                    higincome:"Hauts revenus",
                    incomelev:"Niveau de revenu",
                    incomeof:"Les revenus du",
                    ofpopwith:"de la population avec les",
                    lowest:"plus bas",
                    highest:"plus hauts",
                    incomeis:"revenus est",
                    oftotal:"du total des revenus du pays",
                    ifincomewas:"Si les revenus étaient équitablement répartis, ce serait",
                    thisincis:"Ces revenus sont",
                    times:"fois",
                    higher:"plus hauts",
                    lower:"plus bas",
                    thanav:"que le revenu moyen",
                    percent:"pourcent",
                    twentieth:"vingtième",
                    twentyfifth:"vingtcinquième",
                    tenth:"dixième",
                    sourceTxt:"Sources: Bases de données <a href='http://ec.europa.eu/eurostat/'>Eurostat</a> sur la répartition des revenus (<a href='http://ec.europa.eu/eurostat/web/income-and-living-conditions/overview'>EU-SILC</a>). Plus d'information <a href='http://ec.europa.eu/eurostat/statistics-explained/index.php/Income_distribution_statistics'>ici</a>."
                }
            };

            //select dictionnary
            dict = dict[lg] || dict.en;
            //try to fill page with translated terms
            PrVis.writeText(dict);


            //write page title
            document.title = dict.title;

            //some quantile data
            var quantileDict = {P:{percentage:1,text:"percent"},T:{percentage:5,text:"twentieth"},F:{percentage:4,text:"twentyfifth"},D:{percentage:10,text:"tenth"}};

            //dimensions
            var margin = {top: 2, right: 2, bottom: 2, left: 2};
            var width = 150 - margin.left - margin.right, height = 100 - margin.top - margin.bottom;

            //chart axis scales
            var xScale = d3.scale.linear().domain([0,100]).range([0, width]);
            var yMax = 75; //TODO adapt max? min?
            var yScale = d3.scale.linear().domain([0,yMax]).range([0, height]);


            //time slider
            var sli = $("#timeslider");
            sli.css("width",200);

            //the selection
            var timeSel = PrVis.getParameterByName("time") || "2014";

            //build data array
            var getDataObj = function(data, geo){
                var dataObj = {}, i, obj = {currency:"EUR",indic_il:"SHARE",time:timeSel,geo:geo,quantile:""};
                //deciles
                for(i=1;i<=10;i++) { obj.quantile="D"+i; dataObj[obj.quantile] = data.Data(obj)?data.Data(obj).value : 0; }
                //first percentiles
                for(i=1;i<=5;i++) { obj.quantile="P"+i; dataObj[obj.quantile] = data.Data(obj)?data.Data(obj).value : 0; }
                //last percentiles
                for(i=95;i<=100;i++) { obj.quantile="P"+i; dataObj[obj.quantile] = data.Data(obj)?data.Data(obj).value : 0; }
                //compute second twentile as first decile value minus five first percentiles values
                dataObj.T2 = dataObj.D1; for(i=1;i<=5;i++) dataObj.T2 -= dataObj["P"+i];
                dataObj.T2 = Math.round(dataObj.T2*10)/10;
                //compute 19th twentile value as last decile value, minus five last percentiles values
                dataObj.F19 = dataObj.D10; for(i=95;i<=100;i++) dataObj.F19 -= dataObj["P"+i];
                dataObj.F19 = Math.round(dataObj.F19*10)/10;
                //remove decile data when corresponding percentiles are available
                if(percentileDataPresent(dataObj, true)) {
                    dataObj.D1=0;
                } else {
                    for(i=1;i<=5;i++) dataObj["P"+i] = 0;
                    dataObj.T2=0;
                }
                if(percentileDataPresent(dataObj, false)) {
                    dataObj.D10=0;
                } else {
                    for(i=95;i<=100;i++) dataObj["P"+i] = 0;
                    dataObj.F19=0;
                }
                return dataObj;
            };

            //check presence of percentile data (if they are all equal to 0 and none is equal to null)
            var percentileDataPresent = function(dataObj, first){
                var nbs = first? [1,2,3,4,5] : [95,96,97,98,99,100], i;
                for(i=0;i<nbs.length;i++) if(dataObj["P"+nbs[i]] == null) return false;
                for(i=0;i<nbs.length;i++) if(dataObj["P"+nbs[i]] != 0) return true;
                return false;
            };

            //check presence of data (if at least one is defined and non null)
            var dataPresence = function(dataObj){
                for(var k in dataObj) {
                    var v = dataObj[k];
                    if(v != null && v != 0) return true;
                }
                return false;
            };

            $.when(
                    //get income distribution data
                    $.ajax({url:EstLib.getEstatDataURL("ilc_di01",{currency:"EUR",indic_il:"SHARE",
                                quantile:["P100","P99","P98","P97","P96","P95","D10","D9","D8","D7","D6","D5","D4","D3","D2","D1","P5","P4","P3","P2","P1"]
                            }, lg
                    )})
            ).then(function(data) {
                        //simplify geo label texts
                        EstLib.overrideCountryNames(data.dimension.geo.category.label);

                        //decode data
                        data = JSONstat(data).Dataset(0);

                        //build time slider
                        var times = data.Dimension("time").id;
                        sli.slider({
                            min: +times[0],
                            max: +times[times.length-1],
                            step: 1,
                            value: timeSel,
                            change: function() { timeSel= ""+sli.slider("value"); update(); }
                            //slide: function() { timeSel= ""+sli.slider("value"); update(); }
                        }).each(function() {
                            var opt = $(this).data().uiSlider.options;
                            var www = opt.max - opt.min;
                            for (var i = opt.min; i <= opt.max; i+=5)
                                sli.append( $('<label>' + i + '</label>').css('left', ((i-opt.min)/www*100) + '%') );
                        });

                        //get geos
                        var geos = data.Dimension("geo").id;
                        geos.splice(geos.indexOf("EA12"),1);
                        geos.splice(geos.indexOf("EA17"),1);
                        geos.splice(geos.indexOf("EA18"),1);
                        geos.splice(geos.indexOf("EU15"),1);
                        geos.splice(geos.indexOf("EU27"),1);
                        geos.splice(geos.indexOf("NMS12"),1);


                        //build initial charts
                        for(var j=0; j<geos.length; j++) {
                            var geo = geos[j];

                            //build svg element
                            var svg = d3.select("#charts")
                                    .append("svg")
                                    .attr("id", "svg"+geo)
                                    .attr("width", width + margin.left + margin.right)
                                    .attr("height", height + margin.top + margin.bottom);
                            var chart = svg.append("g").attr("transform", "translate("+margin.left+","+margin.top+ ")");

                            //background rectangle
                            chart.append("rect").attr({y:0,x:0,width:width,height:height,fill:"#f5f5f5"})
                                    .on("click", function() { window.open("income_distr.html?geo="+geo+"&time="+timeSel, "_blank"); });

                            var noData = chart.append("g").attr("id","nodata"+geo).append("text").attr({x:width*0.5-30,y:height*0.5,"font-size":"14px"}).text("No data");

                            //rectangles
                            var rects = chart.append("g").attr("id","disrect"+geo).attr("class","disrect");
                            var addRect = function(quantileType,quantileNb,pos){
                                rects.append("rect").attr("x",xScale(pos)).attr("y",yScale(yMax))
                                        .attr("width",xScale(quantileDict[quantileType].percentage)).attr("height",yScale(0))
                                        .attr("fill","peru");
                            };
                            //deciles
                            var i;
                            for(i=1;i<=10;i++) addRect("D",i,10*(i-1));
                            //first 5 percentiles
                            for(i=0;i<=4;i++) addRect("P",i+1,i);
                            //last 5 percentiles
                            for(i=95;i<=100;i++) addRect("P",i,i-1);
                            //second twentile
                            addRect("T",2,5);
                            //19th twentyfifth
                            addRect("F",24,90);

                            svg.append("text").attr({x:5,y:17,"font-size":"12px"}).text(
                                    data.Dimension("geo").Category(geo).label
                                    //geo
                            );
                        }


                        //update the chart
                        var update = function(){
                            for(var i=0; i<geos.length; i++){
                                var geo = geos[i];
                                var dataObj = getDataObj(data, geo);
                                var rects = d3.select("#disrect"+geo);
                                var noData = d3.select("#nodata"+geo);

                                if(!dataPresence(dataObj)) {
                                    noData.style("opacity", 1);
                                    rects.style("opacity", 0);
                                } else {
                                    //show
                                    noData.style("opacity", 0);
                                    rects.style("opacity", 1);

                                    rects.selectAll("rect").data(d3.keys(dataObj))
                                            .transition().attr("y", function(d){
                                                var value = dataObj[d], factor = 10.0/quantileDict[d.charAt(0)].percentage;
                                                return yScale(value<0?yMax:yMax-factor*value);
                                            })
                                            .attr("height", function(d){
                                                var value = dataObj[d], factor = 10.0/quantileDict[d.charAt(0)].percentage;
                                                return yScale(factor*Math.abs(value));
                                            })
                                    ;
                                }
                            }

                            //update title
                            d3.select("#timeTitle").text(timeSel);
                        };

                        update();

                    }, function() {
                        console.log("Could not load data");
                    }
            );
        });
    }(jQuery));

</script>

</body>
</html>
