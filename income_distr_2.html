<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf8" />
    <title>Income disparities in Europe</title>

    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">

    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/colorbrewer.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/json-stat.js"></script>
    <script src="js/lib.js"></script>
    <script src="js/eurostat-lib.js"></script>
    <script src="js/income_distr.js"></script>

    <style>
        body {
            font-family: sans-serif;
        }

        h1 {
            font-size: 22px;
        }

        .disrect rect {
            /*fill: peru;*/
            stroke-width: 0;
        }

        #timeslider label {
            position: absolute;
            width: 20px;
            margin-top: 12px;
            margin-left: -10px;
            text-align: center;
            font-size: 10px;
        }

        .chartLabels {
            font-size: 14px;
            /*fill: gray;*/
        }

        .svgCntr {
            cursor: pointer;
        }

        .arrow {
            marker-end: url(#arrow);
            stroke: gray;
            stroke-width: 2.5px;
        }

        #averageLine {
            stroke: black;
            stroke-width: 2px;
            opacity: 0.5;
        }

        .graticuleYline {
            stroke: black;
            stroke-width: 2px;
            opacity: 0.15;
        }

        .ui-widget {
            font-size: 12px !important;
        }

        #info {
            opacity: 0;
            position: absolute;
            padding: 10px;
            width: 300px;
            background: white;
            border: 0px;
            border-radius: 10px;
            font: 16px sans-serif;
            pointer-events: none;
            box-shadow: 10px 10px 5px grey;
        }

        #timeslider {
            width: 200px;
        }

        .nodataTxt {
            opacity:0;
            font-size: 14px;
            font-weight:bold;
            text-anchor:middle
        }

    </style>

</head>

<body>
<h1>
    <span id="title1"></span> <span id="title2"></span> <span
        id="timeTitle">-</span>
</h1>
<div style="padding-bottom: 25px; padding-left: 10px;">
    <span id="yearText"></span>
    <div id="timeslider"></div>
</div>
<div id="charts"></div>
<div>
    <p>
        <span id="sourceTxt"></span>
    </p>
</div>
<div id="info">Test</div>

<script>

    /**
     *
     * @author julien Gaffuri
     *
     */
    (function($, EstLib) {
        $(function() {
            //http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=ilc_di01&lang=fr

            //TODO show line with average income
            //TODO clean styles
            //TODO change order - start with EU and EA, with other color ? See p35
            //TODO handle country name translation in EstLib.overrideCountryNames

            //get language
            var lg = PrVis.getLang2Chars();

            //select dictionnary
            var dict = EstLib.dictIncomeDistr;
            dict = dict[lg] || dict.en;
            //try to fill page with translated terms
            PrVis.writeText(dict);


            //write page title
            document.title = dict.title;

            //dimensions
            var margin = {top: 4, right: 4, bottom: 4, left: 4};
            var width = 200 - margin.left - margin.right, height = 130 - margin.top - margin.bottom;

            //chart axis scales
            var xScale = d3.scale.linear().domain([0,100]).range([0, width]);
            var yMax = 75; //TODO adapt max? min?
            var yScale = d3.scale.linear().domain([0,yMax]).range([0, height]);

            //the selection
            var timeSel = PrVis.getParameterByName("time") || "2014";

            //info
            var infoDiv = d3.select("#info");

            $.when(
                    //get income distribution data
                    $.ajax({url:EstLib.getEstatDataURL("ilc_di01",{currency:"EUR",indic_il:"SHARE",
                                quantile:["P100","P99","P98","P97","P96","P95","D10","D9","D8","D7","D6","D5","D4","D3","D2","D1","P5","P4","P3","P2","P1"]
                            }, lg
                    )})
            ).then(function(data) {
                        //simplify geo label texts
                        EstLib.overrideCountryNames(data.dimension.geo.category.label);

                        //decode data
                        data = JSONstat(data).Dataset(0);

                        //build time slider
                        EstLib.buildTimeSlider($("#timeslider"), data.Dimension("time").id, timeSel, 5, function() {
                            timeSel= ""+$("#timeslider").slider("value");
                            update();
                        });

                        //get geos
                        var geos = data.Dimension("geo").id;
                        geos.splice(geos.indexOf("EA12"),1);
                        geos.splice(geos.indexOf("EA17"),1);
                        geos.splice(geos.indexOf("EA18"),1);
                        geos.splice(geos.indexOf("EU15"),1);
                        geos.splice(geos.indexOf("EU27"),1);
                        geos.splice(geos.indexOf("NMS12"),1);

                        //build initial charts
                        for(var j=0; j<geos.length; j++) {
                            var geo = geos[j];

                            //build svg element
                            var svg = d3.select("#charts")
                                    .append("svg")
                                    .attr("id", "svg"+geo)
                                    .attr("class", "svgCntr")
                                    .attr("width", width + margin.left + margin.right)
                                    .attr("height", height + margin.top + margin.bottom)
                                    .attr("geo", geo).on("click", function() { window.open("income_distr.html?geo="+d3.select(this).attr("geo")+"&time="+timeSel+"&lang="+lg, "_blank"); });

                            var chart = svg.append("g").attr("transform", "translate("+margin.left+","+margin.top+ ")");

                            //background rectangle
                            chart.append("rect").attr({y:0,x:0,width:width,height:height,fill:"#eee"});

                            //no data
                            chart.append("g").attr("id","nodata"+geo).attr("class","nodataTxt")
                                    .append("text").attr({x:width*0.5,y:height*0.5+7}).text(dict.nodata);

                            //rectangles
                            var rects = chart.append("g").attr("id","disrect"+geo).attr("class","disrect");
                            var addRect = function(quantileType,quantileNb,pos){
                                rects.append("rect").attr("x",xScale(pos)).attr("y",yScale(yMax))
                                        .attr("width",xScale(EstLib.quantileDict[quantileType].percentage)).attr("height",yScale(0))
                                        .attr("fill","peru");
                            };
                            //deciles
                            var i;
                            for(i=1;i<=10;i++) addRect("D",i,10*(i-1));
                            //first 5 percentiles
                            for(i=0;i<=4;i++) addRect("P",i+1,i);
                            //last 5 percentiles
                            for(i=95;i<=100;i++) addRect("P",i,i-1);
                            //second twentile
                            addRect("T",2,5);
                            //19th twentyfifth
                            addRect("F",24,90);

                            //country name title
                            svg.append("text").attr({x:35,y:26,"font-size":"14px"}).text( data.Dimension("geo").Category(geo).label );

                            //flag
                            svg.append("svg:image")
                                    .attr("x",10).attr("y",10).attr('width', 20).attr('height', 20)
                                    .attr("xlink:href","img/flags/1/"+(geo.substring(0,2))+".png")
                        }


                        //update the chart
                        var update = function(){
                            for(var i=0; i<geos.length; i++){
                                var geo = geos[i];
                                var dataObj = EstLib.getDataObj(data, geo, timeSel);
                                var rects = d3.select("#disrect"+geo);
                                var noData = d3.select("#nodata"+geo);

                                if(!EstLib.dataPresence(dataObj)) {
                                    noData.transition().style("opacity", 1);
                                } else {
                                    noData.transition().style("opacity", 0);
                                }

                                rects.selectAll("rect").data(d3.keys(dataObj))
                                        .on("mouseover", function(d) {
                                            d3.select(this).attr("fill","darkred ");
                                            infoDiv.html(EstLib.getRectText(d, dataObj[d], lg))
                                                    .style("left", (d3.event.pageX+30) + "px").style("top", (d3.event.pageY-50) + "px")
                                                    .transition().duration(200).style("opacity",1);
                                        })
                                        .on("mouseout", function() {
                                            d3.select(this).attr("fill","peru");
                                            infoDiv.transition().duration(200).style("opacity",0);
                                        })
                                        .transition()
                                        .attr("y", function(d){
                                            var value = dataObj[d] || 0, factor = 10.0/EstLib.quantileDict[d.charAt(0)].percentage;
                                            return yScale(value<0?yMax:yMax-factor*value);
                                        })
                                        .attr("height", function(d){
                                            var value = dataObj[d] || 0, factor = 10.0/EstLib.quantileDict[d.charAt(0)].percentage;
                                            return yScale(factor*Math.abs(value));
                                        });
                            }

                            //update title
                            d3.select("#timeTitle").text(timeSel);
                        };

                        update();

                    }, function() {
                        console.log("Could not load data");
                    }
            );
        });
    }(jQuery, window.EstLib = window.EstLib || {} ));

</script>

</body>
</html>
